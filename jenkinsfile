pipeline {

  agent {
    node {
      label "master"
    }
  }

  environment {
    TF_VAR_az_subscription_id = credentials('jenkins-azure-subscription-id')
    TF_VAR_az_client_id       = credentials('jenkins-azure-client-id')
    TF_VAR_az_tenant_id       = credentials('jenkins-azure-tenant-id')
    TF_VAR_az_client_secret   = credentials('jenkins-azure-client-secret')
  }

  stages {

    // FIXME: Change back to the main branch
    stage('Fetch repository') {
      steps {
        git branch: 'jenkins_deployment',
        url: 'https://github.com/kgacheva/fmi-mt-automatic-deployment.git'
      }
    }

    stage('Terraform: Initialize workspace') {
      steps {
        sh 'cd $WORKSPACE/deployer && terraform -chdir=modules/${TF_DEPL_ENV}/builder-worker init'
      }
    }

    // TODO: Handle the passing of the configuration file in a more flexible way
    stage('Terraform: Generate plan') {
      steps {
        sh '''terraform -chdir=modules/${TF_DEPL_ENV}/builder-worker plan
        -var-file=../../../configurations/${TF_DEPL_ENV}/mt_playground.tfvars'''
      }
    }

    // stage('Terraform: Approve plan') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }

    // stage('Terraform: Apply plan and deploy') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }

    // stage('Packer: Run templater') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }

    // stage('QEMU: Convert template') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }

    // stage('Azure: Upload template as an image') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }
  }
}
