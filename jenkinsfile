pipeline {

  agent {
    node {
      label "slave01"
    }
  }

  environment {
    TF_VAR_az_subscription_id = credentials('jenkins-azure-subscription-id')
    TF_VAR_az_client_id       = credentials('jenkins-azure-client-id')
    TF_VAR_az_tenant_id       = credentials('jenkins-azure-tenant-id')
    TF_VAR_az_client_secret   = credentials('jenkins-azure-client-secret')
  }

  stages {

    stage('Fetch repository') {
      steps {
        git branch: 'main',
        url: 'https://github.com/kgacheva/fmi-mt-automatic-deployment.git'
      }
    }

    stage('Terraform: Initialize workspace') {
      steps {
        sh 'cd $WORKSPACE/deployer && terraform -chdir=modules/${TF_DEPL_ENV}/builder-worker init'
      }
    }

    stage('Terraform: Generate plan') {
      steps {
        sh 'cd $WORKSPACE/deployer && terraform -chdir=modules/${TF_DEPL_ENV}/builder-worker plan -var-file=../../../configurations/${TF_DEPL_ENV}/builder_worker_eph.tfvars'
      }
    }

    stage('Terraform: Approve plan') {
      steps {
        input message: 'Apply the Terraform plan?', ok: 'Yes'
      }
    }

    stage('Terraform: Apply plan and deploy') {
      steps {
        sh 'cd $WORKSPACE/deployer && terraform -chdir=modules/${TF_DEPL_ENV}/builder-worker apply -var-file=../../../configurations/${TF_DEPL_ENV}/builder_worker_eph.tfvars -auto-approve'
      }
    }

    // stage('Packer: Run templater') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }

    // stage('QEMU: Convert template') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }

    // stage('Azure: Upload template as an image') {
    //   steps {
    //     // One or more steps need to be included within the steps block.
    //   }
    // }
  }

  post {
    always {
        sh 'cd $WORKSPACE/deployer && terraform -chdir=modules/${TF_DEPL_ENV}/builder-worker destroy -var-file=../../../configurations/${TF_DEPL_ENV}/builder_worker_eph.tfvars -auto-approve'
    }
  }
}
